import{colors as f,fs as v,getDirname as tt,path as C}from"@vuepress/utils";import{fromEntries as P,entries as k,encodeXMLContent as R,encodeCDATA as et,isArray as _,isPlainObject as j,Logger as at,isLinkHttp as F,removeEndingSlash as E,removeLeadingSlash as D,isUrl as L,isAbsoluteUrl as I,HTML_TAGS as it,SVG_TAGS as st,MATHML_TAGS as nt,isFunction as h,getPageText as rt,getAuthor as H,getCategory as ot,getPageExcerpt as lt,ensureEndingSlash as pt,values as ut,keys as J,deepAssign as ct,checkVersion as mt}from"vuepress-shared/node";import{js2xml as K}from"xml-js";import{load as ht}from"cheerio";const M=e=>P(k(e).map(([t,a])=>t==="_attributes"&&a?[t,P(k(a).map(([i,n])=>[i,n?R(n.toString()):void 0]))]:t==="_text"?[t,R(a.toString())]:t==="_cdata"?[t,et(a)]:t==="_comment"||t==="_instruction"?[t,a]:_(a)?[t,a.map(i=>M(i))]:j(a)?[t,M(a)]:[t,R(String(a))])),U="vuepress-plugin-feed2",x=new at(U),q=(e,t)=>!e||!(e instanceof Date)?1:!t||!(t instanceof Date)?-1:t.getTime()-e.getTime(),c=(e,t="",a="")=>`${F(e)?E(e):`https://${E(e)}`}${t}${D(a)}`,dt=(e="")=>`image/${e==="jpg"?"jpeg":e==="svg"?"svg+xml":e==="jpeg"||e==="png"||e==="bmp"||e==="gif"||e==="webp"?e:""}`,V=({options:e,deprecatedOption:t,newOption:a,msg:i="",scope:n=""})=>{if(t in e){if(x.warn(`${f.magenta(t)} is ${f.yellow("deprecated")}${n?` in ${n}`:""}, please use "${f.magenta(a)}" instead.${i?`
${i}`:""}`),a.includes(".")){const s=a.split(".");let r=e;s.forEach((o,l)=>{l!==s.length-1?(r[o]=r[o]||{},r=r[o]):r[o]=e[t]})}else e[a]=e[t];delete e[t]}},gt=(e,t,a="",i="")=>{t in e&&(x.error(`"${f.magenta(t)}" is ${f.red("removed")}${i?`, please use ${f.magenta(i)} instead.`:" and no longer supported"}${a?`
${a}`:""}`),i||delete e[t])},ft=e=>{var t,a,i,n,s,r;const o=e.output;j(o)&&(e.atom=((t=o.atom)==null?void 0:t.enable)??!1,e.json=((a=o.json)==null?void 0:a.enable)??!1,e.rss=((i=o.rss)==null?void 0:i.enable)??!1,e.atomOutputFilename=((n=o.atom)==null?void 0:n.path)??"atom.xml",e.jsonOutputFilename=((s=o.json)==null?void 0:s.path)??"feed.json",e.rssOutputFilename=((r=o.rss)==null?void 0:r.path)??"rss.xml"),V({options:e,deprecatedOption:"customElements",newOption:"preservedElements"}),V({options:e,deprecatedOption:"removedElements",newOption:"preservedElements"}),gt(e,"output")},N=e=>{const{name:t="Unknown",email:a,url:i}=e;return{name:t,...a?{email:a}:{},...i?{uri:i}:{}}},bt=e=>{const{name:t,scheme:a=""}=e;return{_attributes:{term:t,scheme:a}}},yt=e=>{const{channel:t,links:a}=e.options,i={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${a.atomXsl}"`},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:_(t.author)?t.author.map(n=>N(n)):[N(t.author)]}:{},...t.icon?{icon:t.icon}:{},...t.image?{logo:t.image}:{},...t.copyright?{rights:t.copyright}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:U,link:[{_attributes:{rel:"self",href:a.atom}}]}};return t.link&&i.feed.link.push({_attributes:{rel:"alternate",href:t.link}}),t.hub&&i.feed.link.push({_attributes:{rel:"hub",href:t.hub}}),t.image&&(i.feed.logo=t.image),t.icon&&(i.feed.icon=t.icon),t.copyright&&(i.feed.rights=t.copyright),i.feed.category=Array.from(e.categories).map(n=>({_attributes:{term:n}})),i.feed.contributor=Array.from(e.contributors).filter(n=>n.name).map(n=>N(n)),i.feed.entry=e.items.map(n=>{const s={title:{_attributes:{type:"text"},_text:n.title},id:n.guid||n.link,link:{_attributes:{href:n.link}},updated:n.lastUpdated.toISOString()};return n.summary?s.summary={_attributes:{type:"html"},_cdata:n.summary}:n.description&&(s.summary={_attributes:{type:"text"},_text:n.description}),n.content&&(s.content={_attributes:{type:"html"},_cdata:n.content}),n.author&&(s.author=n.author.filter(r=>r.name).map(r=>N(r))),n.category&&(s.category=n.category.map(r=>bt(r))),n.contributor&&(s.contributor=n.contributor.map(r=>N(r))),n.pubDate&&(s.published=n.pubDate.toISOString()),n.copyright&&(s.rights=n.copyright),s}),K(M(i),{compact:!0,ignoreComment:!0,spaces:2})},z=e=>({name:e.name,...e.url?{url:e.url}:{},...e.avatar?{avatar:e.avatar}:{}}),vt=e=>{const{channel:t,links:a}=e.options,i={version:"https://jsonfeed.org/version/1.1",title:t.title,home_page_url:t.link,feed_url:a.json};t.description&&(i.description=t.description),t.image&&(i.icon=t.image),t.icon&&(i.favicon=t.icon);const n=(_(t.author)?t.author:t.author?[t.author]:[]).filter(s=>!!(s!=null&&s.name));return n.length&&(i.authors=n.map(s=>z(s))),i.items=e.items.map(s=>{const r={title:s.title,url:s.link,id:s.guid||s.link,...s.description?{summary:s.description}:{},content_html:s.content};return s.image&&(r.image=s.image),s.pubDate&&(r.date_published=s.pubDate.toISOString()),s.lastUpdated&&(r.date_modified=s.lastUpdated.toISOString()),_(s.author)&&(r.authors=s.author.filter(o=>o.name).map(o=>z(o))),s.category&&(r.tags=s.category.filter(o=>o.name).map(o=>o.name)),r}),JSON.stringify(i,null,2)},_t=e=>{const{name:t,domain:a}=e;return{_text:t,...a?{_attributes:{domain:a}}:{}}},Ot=e=>{const t=e.guid||e.link;return{...L(t)?{}:{_attributes:{isPermaLink:"false"}},_text:t}},xt=e=>({_attributes:{url:e.url,...e.length?{length:e.length}:{},...e.type?{type:e.type}:{}}}),$t=e=>{const{links:t,channel:a}=e.options;let i=!1;const n={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},_instruction:{"xml-stylesheet":`type="text/xsl" href="${t.rssXsl}"`},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:a.title},link:{_text:a.link},description:{_text:a.description},language:{_text:a.language},pubDate:{_text:a.pubDate?a.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:a.lastUpdated?a.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:U},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return a.copyright&&(n.rss.channel.copyright={_text:a.copyright}),a.ttl&&(n.rss.channel.ttl={_text:a.ttl.toString()}),a.image&&(n.rss.channel.image={title:{_text:a.title},url:{_text:a.image},link:{_text:a.link}}),n.rss.channel.category=Array.from(e.categories).map(s=>({_text:s})),n.rss.channel.item=e.items.map(s=>{const r={title:{_text:s.title},link:{_text:s.link},guid:Ot(s),source:{_attributes:{url:t.rss},_text:s.title}};if(s.description&&(r.description={_text:s.description}),s.author){const o=s.author.find(l=>l.email&&l.name);o&&(r.author={_text:`${o.email} (${o.name})`})}return s.category&&(r.category=s.category.filter(o=>o.name).map(o=>_t(o))),s.comments&&(r.comments={_text:s.link}),s.pubDate&&(r.pubDate={_text:s.pubDate.toUTCString()}),s.content&&(i=!0,r["content:encoded"]={_cdata:s.content}),s.enclosure&&(r.enclosure=xt(s.enclosure)),r}),i&&(n.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",n.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),K(M(n),{compact:!0,ignoreComment:!0,spaces:2})};class Ft{constructor(t){this.options=t}items=[];categories=new Set;_contributorKeys=new Set;contributors=[];addItem=t=>{this.items.push(t)};addCategory=t=>{this.categories.add(t)};addContributor=t=>{const a=t.email||t.name;a&&!this._contributorKeys.has(a)&&(this._contributorKeys.add(a),this.contributors.push(t))};atom=()=>yt(this);rss=()=>$t(this);json=()=>vt(this)}const kt=["h1","h2","h3","h4","h5","h6"],B=(e,t,a)=>{if(e.type==="tag"){if(e.tagName==="img"){const{src:i}=e.attribs;if(!F(i)&&!I(i))return null}return[e.attribs.class,e.attribs.id].some(i=>["table-of-contents","toc"].includes(i))||e.tagName==="pre"?null:it.includes(e.tagName)||st.includes(e.tagName)||nt.includes(e.tagName)?(kt.includes(e.tagName)&&(delete e.attribs.id,delete e.attribs.tabindex,e.children=e.children.filter(i=>i.type!=="tag"||i.tagName!=="a"||i.attribs.class!=="header-anchor")),e.tagName==="code"&&delete e.attribs["v-pre"],e.children=Q(e.children,t,a),e):e.tagName==="routerlink"||e.tagName==="vplink"?(e.tagName="a",e.attribs.href=`${E(t)}${e.attribs.to}`,e.attribs.target="blank",delete e.attribs.to,e.children=Q(e.children,t,a),e):a(e.tagName)?e:null}return e},Q=(e,t,a)=>_(e)?e.map(i=>B(i,t,a)).filter(i=>i!==null):[],W=ht(""),Dt=(e,t,a)=>{const i=e.dir.dest(t.path),n=v.existsSync(i)?v.readFileSync(i,"utf-8"):t.contentRendered;let s="";const r=W.parseHTML(n)||[];for(const o of r){const l=B(o,e.options.base,a);l&&(s+=`${W.html(l)}`)}return s};class St{constructor(t,a,i,n){this.app=t,this.options=a,this.page=i,this.feed=n,this.base=this.app.options.base,this.frontmatter=i.frontmatter,this.getter=a.getter||{},this.pageOptions=this.frontmatter.feed||{},this.isPreservedElement=s=>{const{preservedElements:r}=this.options;return _(r)?r.some(o=>o instanceof RegExp?o.test(s):o===s):h(r)?r(s):!1}}pageOptions;frontmatter;base;getter;isPreservedElement;get title(){return h(this.getter.title)?this.getter.title(this.page):this.pageOptions.title||this.page.title}get link(){return h(this.getter.link)?this.getter.link(this.page):c(this.options.hostname,this.base,this.page.path)}get description(){if(h(this.getter.description))return this.getter.description(this.page);if(this.pageOptions.description)return this.pageOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=rt(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){var t,a;return h(this.getter.author)?this.getter.author(this.page):_(this.pageOptions.author)?this.pageOptions.author:j(this.pageOptions.author)?[this.pageOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?H(this.frontmatter.author):(t=this.options.channel)!=null&&t.author?H((a=this.options.channel)==null?void 0:a.author):[]}get category(){if(h(this.getter.category))return this.getter.category(this.page);if(_(this.pageOptions.category))return this.pageOptions.category;if(j(this.pageOptions.category))return[this.pageOptions.category];const{categories:t,category:a=t}=this.frontmatter;return ot(a).map(i=>({name:i}))}get enclosure(){return h(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:dt(this.image.split(".").pop())}:null}get guid(){return this.pageOptions.guid||this.link}get pubDate(){if(h(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:a=t}=this.page.frontmatter,{createdTime:i}=this.page.data.git||{};return a&&a instanceof Date?a:i?new Date(i):null}get lastUpdated(){if(h(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get excerpt(){return h(this.getter.excerpt)?this.getter.excerpt(this.page):this.pageOptions.summary?this.pageOptions.summary:lt(this.app,this.page,{isCustomElement:this.isPreservedElement})}get content(){return h(this.getter.content)?this.getter.content(this.page):this.pageOptions.content?this.pageOptions.content:Dt(this.app,this.page,this.isPreservedElement)}get image(){if(h(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:a}=this.frontmatter;if(t){if(I(t))return c(this.options.hostname,this.app.options.base,t);if(L(t))return t}if(a){if(I(a))return c(this.options.hostname,this.app.options.base,a);if(L(a))return a}const i=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(i){if(I(i[1]))return c(this.options.hostname,this.app.options.base,i[1]);if(L(i[1]))return i[1]}return null}get contributor(){return h(this.getter.contributor)?this.getter.contributor(this.page):_(this.pageOptions.contributor)?this.pageOptions.contributor:j(this.pageOptions.contributor)?[this.pageOptions.contributor]:this.author}get copyright(){if(h(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t!=null&&t.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:a,content:i,contributor:n,copyright:s,description:r,enclosure:o,excerpt:l,guid:p,image:u,lastUpdated:d,link:g,pubDate:m,title:b}=this;return!b&&!r?null:(a&&a.forEach(y=>this.feed.addCategory(y.name)),n&&n.forEach(y=>this.feed.addContributor(y)),{title:b,link:g,guid:p,lastUpdated:d,content:i,author:t,contributor:n,...r?{description:r}:{},...l?{summary:l}:{},...a?{category:a}:{},...o?{enclosure:o}:{},...m?{pubDate:m}:{},...u?{image:u}:{},...s?{copyright:s}:{}})}}const wt=tt(import.meta.url),Y=pt(C.resolve(wt,"../../templates")),Tt=e=>e.hostname?(e.hostname=F(e.hostname)?E(e.hostname):`https://${E(e.hostname)}`,!0):!1,jt=e=>e.locales&&ut(e.locales).some(({atom:t,json:a,rss:i})=>t||a||i)||!!(e.atom||e.json||e.rss),Et=({siteData:e},t)=>P(J({"/":{},...e.locales}).map(a=>{var i;return[a,{filter:({frontmatter:n,filePathRelative:s})=>!(n.home||!s||n.article===!1||n.feed===!1),sorter:(n,s)=>{var r,o,l,p;return q((r=n.data.git)!=null&&r.createdTime?new Date((o=n.data.git)==null?void 0:o.createdTime):n.frontmatter.date,(l=s.data.git)!=null&&l.createdTime?new Date((p=s.data.git)==null?void 0:p.createdTime):s.frontmatter.date)},...t,...(i=t.locales)==null?void 0:i[a],hostname:t.hostname}]})),Ut=(e,t,a="")=>{var i,n,s,r,o,l,p,u,d,g;const{base:m}=e.options,{title:b,description:y,lang:$,locales:w}=e.siteData,{channel:O={},hostname:T,icon:X,image:A}=t,G=_((i=t.channel)==null?void 0:i.author)?(s=(n=t.channel)==null?void 0:n.author[0])==null?void 0:s.name:(o=(r=t.channel)==null?void 0:r.author)==null?void 0:o.name,Z={title:((l=w[a])==null?void 0:l.title)||b||((p=w["/"])==null?void 0:p.title)||"",link:c(T,m,a),description:((u=w[a])==null?void 0:u.description)||y||((d=w["/"])==null?void 0:d.description)||"",language:((g=w[a])==null?void 0:g.lang)||$,copyright:G?`Copyright by ${G}`:"",pubDate:new Date,lastUpdated:new Date,...X?{icon:F(X)?X:c(T,m,X)}:{},...A?{image:F(A)?A:c(T,m,A)}:{}};return ct(Z,O,{...O.icon?{icon:F(O.icon)?O.icon:c(T,m,O.icon)}:{},...O.image?{image:F(O.image)?O.image:c(T,m,O.image)}:{}})},S=(e,t="/")=>({atomOutputFilename:`${D(t)}${e.atomOutputFilename||"atom.xml"}`,atomXslFilename:`${D(t)}${e.atomXslFilename||"atom.xsl"}`,atomXslTemplate:e.atomXslTemplate||`${Y}atom.xsl`,jsonOutputFilename:`${D(t)}${e.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${D(t)}${e.rssOutputFilename||"rss.xml"}`,rssXslFilename:`${D(t)}${e.rssXslFilename||"rss.xsl"}`,rssXslTemplate:e.rssXslTemplate||`${Y}rss.xsl`}),Nt=({options:{base:e}},t,a)=>{const{hostname:i}=t,{atomOutputFilename:n,atomXslFilename:s,jsonOutputFilename:r,rssOutputFilename:o,rssXslFilename:l}=S(t,a);return{localePath:a,atom:c(i,e,n),atomXsl:c(i,e,s),json:c(i,e,r),rss:c(i,e,o),rssXsl:c(i,e,l)}};class Xt{constructor(t,a){this.app=t,this.options=a,this.feedMap=P(k(a).map(([i,n])=>[i,new Ft({channel:Ut(t,n,i),links:Nt(t,n,i)})]))}feedMap;addPages(t){const a=this.feedMap[t],i=this.options[t],{count:n=100,filter:s=({frontmatter:p,filePathRelative:u})=>!(p.home||!u||p.article===!1||p.feed===!1),sorter:r=(p,u)=>{var d,g,m,b;return q((d=p.data.git)!=null&&d.createdTime?new Date((g=p.data.git)==null?void 0:g.createdTime):p.frontmatter.date,(m=u.data.git)!=null&&m.createdTime?new Date((b=u.data.git)==null?void 0:b.createdTime):u.frontmatter.date)}}=i,o=this.app.pages.filter(p=>p.pathLocale===t).filter(s).sort(r).slice(0,n);let l=0;for(const p of o){const u=new St(this.app,i,p,a).getFeedItem();u&&(a.addItem(u),l+=1)}x.succeed(`added ${f.cyan(`${l} page${l>1?"s":""}`)} as feed item${l>1?"s":""} in route ${f.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all([...k(this.options).map(async([a,i])=>{if(i.atom||i.json||i.rss){const n=this.feedMap[a],{atomOutputFilename:s,jsonOutputFilename:r,rssOutputFilename:o}=S(i,a);this.addPages(a),i.atom&&(await v.ensureDir(C.dirname(t(s))),await v.outputFile(t(s),n.atom()),x.succeed(`Atom feed file generated and saved to ${f.cyan(`/${s}`)}`)),i.json&&(await v.ensureDir(C.dirname(t(r))),await v.outputFile(t(r),n.json()),x.succeed(`JSON feed file generated and saved to ${f.cyan(`/${r}`)}`)),i.rss&&(await v.ensureDir(C.dirname(t(o))),await v.outputFile(t(o),n.rss()),x.succeed(`RSS feed file generated and saved to ${f.cyan(`/${o}`)}`))}}),k(this.options).filter(([,{atom:a}])=>a).map(([a,i])=>{const{atomXslTemplate:n,atomXslFilename:s}=S(i,a);return v.copyFile(n,t(s))}),k(this.options).filter(([,{rss:a}])=>a).map(([a,i])=>{const{rssXslFilename:n,rssXslTemplate:s}=S(i,a);return v.copyFile(s,t(n))})])}}const At=(e,t)=>{const{base:a}=e.options,{siteData:i}=e,n=J(t);if(n.length===1){const{atomOutputFilename:s,jsonOutputFilename:r,rssOutputFilename:o}=S(t["/"]),{atom:l,json:p,rss:u,hostname:d}=t["/"],g=(m,b,y)=>{var $;return["link",{rel:"alternate",type:y,href:c(d,a,b),title:`${i.title||(($=i.locales["/"])==null?void 0:$.title)||""} ${m} Feed`}]};i.head??=[],l&&i.head.push(g("Atom",s,"application/atom+xml")),p&&i.head.push(g("JSON",r,"application/json")),u&&i.head.push(g("RSS",o,"application/rss+xml"))}else e.pages.forEach(s=>{const{pathLocale:r}=s,o=t[r];if(n.includes(r)){const{atomOutputFilename:l,jsonOutputFilename:p,rssOutputFilename:u}=S(o,r),d=(g,m,b)=>{var y,$;return["link",{rel:"alternate",type:b,href:c(o.hostname,a,m),title:`${((y=i.locales[r])==null?void 0:y.title)||i.title||(($=i.locales["/"])==null?void 0:$.title)||""} ${g} Feed`}]};s.frontmatter.head??=[],o.atom&&s.frontmatter.head.push(d("Atom",l,"application/atom+xml")),o.json&&s.frontmatter.head.push(d("JSON",p,"application/json")),o.rss&&s.frontmatter.head.push(d("RSS",u,"application/rss+xml"))}})},Ct=(e,t=!0)=>a=>{t&&ft(e),mt(a,U,"2.0.0-beta.63"),a.env.isDebug&&x.info("Options:",e);const i={name:U};if(!Tt(e))return x.error(`Option ${f.magenta("hostname")} is required!`),i;if(!jt(e))return x.info("No requested output, the plugin won’t start!"),i;const n=Et(a,e);return{...i,onInitialized:s=>At(s,n),onGenerated:s=>new Xt(s,n).generateFeed()}};export{Ct as feedPlugin};
//# sourceMappingURL=index.js.map
